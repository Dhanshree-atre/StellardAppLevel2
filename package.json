#![no_std]
use soroban_sdk::{contract, contractimpl, symbol_short, Address, Env, Symbol, Vec, Map};

#[contract]
pub struct PollContract;

#[contractimpl]
impl PollContract {
    pub fn vote(env: Env, voter: Address, poll_id: u32, option: u32) {
        voter.require_auth();

        // 1. Check if voter already voted for this poll
        let voter_key = (symbol_short!("voter"), poll_id, voter.clone());
        if env.storage().has_temporary(&voter_key) {
            panic!("Already voted");
        }

        // 2. Increment vote count
        let poll_key = (symbol_short!("poll"), poll_id);
        let mut results: Map<u32, u32> = env.storage().persistent().get(&poll_key).unwrap_or(Map::new(&env));
        let count = results.get(option).unwrap_or(0);
        results.set(option, count + 1);
        env.storage().persistent().set(&poll_key, &results);

        // 3. Mark voter as voted (temporary storage)
        env.storage().temporary().set(&voter_key, &true);

        // 4. Emit event
        env.events().publish((symbol_short!("vote"), poll_id), (voter, option));
    }

    pub fn get_results(env: Env, poll_id: u32) -> Map<u32, u32> {
        let poll_key = (symbol_short!("poll"), poll_id);
        env.storage().persistent().get(&poll_key).unwrap_or(Map::new(&env))
    }

    pub fn initialize_poll(env: Env, poll_id: u32) {
        let poll_key = (symbol_short!("poll"), poll_id);
        if !env.storage().persistent().has(&poll_key) {
            env.storage().persistent().set(&poll_key, &Map::<u32, u32>::new(&env));
        }
    }
}
